<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Automated Public Library System</title>
        <style>
            body {
                background-color: white;
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
            }
            h2 {
                text-align: center;
                font-size: 30px;
                margin-bottom: 10px;
            }
            h3 {
                text-align: center;
                font-size: 20px;
                margin-bottom: 20px;
            }
            table {
                width: 85%;
                margin: 20px auto;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid black;
                padding: 7px;
            }
            td:last-child {
                position: absolute;
                border: none;
                text-align: center;
            }
            .search-container {
                position: absolute;
                top: 11%;
                left: 50%;
                transform: translateX(-50%);
                margin-bottom: 20px;
            }

            .search-container form {
                display: flex;
                align-items: center;
            }

            .search-container input[type="text"] {
                padding: 5px;
                margin-right: 10px;
                border-radius: 5px;
                border: 1px solid #ccc;
                width: 300px;
            }
            .button-container {
                position: absolute;
                top: 20px;
                right: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            /* Styles for recommendations section */
            .section-heading {
                text-align: center;
                font-size: 24px;
                margin-top: 30px;
                margin-bottom: 10px;
                color: #333;
                background-color: #f8f8f8;
                padding: 10px;
                border-radius: 5px;
            }
            
            .tab-container {
                display: flex;
                justify-content: center;
                margin: 10px 0;
            }
            
            .tab-button {
                padding: 8px 15px;
                margin: 0 5px;
                border: none;
                background-color: #f0f0f0;
                cursor: pointer;
                border-radius: 5px;
            }
            
            .tab-button.active {
                background-color: #4CAF50;
                color: white;
            }
            
            .recommendations-table {
                background-color: #f9f9f9;
                border: 1px solid #ddd;
            }
            
            .recommendations-table th {
                background-color: #e9e9e9;
            }
            
            .all-books-table {
                margin-top: 40px;
            }
            
            .loading {
                text-align: center;
                padding: 20px;
                font-style: italic;
                color: #666;
            }
        </style>
    </head>

    <body>
        <h2>Automated Public Library System</h2>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search Books">
            <button onclick="searchBooks()">Search</button>
        </div>

        <div class="button-container">
            <div id="userGreeting"></div>
            <button class="view-my-books" onclick="viewMyBooks()">View My Books</button>
            <button class="view-all-books" onclick="viewAllBooks()">All Books</button>
            <button class="logout" onclick="logOut()">Log Out</button>
        </div>

        <!-- Recommendations Section -->
        <div id="recommendationsSection">
            <h3 class="section-heading">Recommended For You</h3>
            
            <div class="tab-container">
                <button class="tab-button active" onclick="showRecommendations('genre')">By Genre</button>
                <button class="tab-button" onclick="showRecommendations('author')">By Author</button>
                <button class="tab-button" onclick="showRecommendations('popular')">Popular</button>
            </div>
            
            <table class="recommendations-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Author</th>
                        <th>Genre</th>
                        <th>Year</th>
                        <th>Recommendation Reason</th>
                    </tr>
                </thead>
                <tbody id="recommendationsList">
                    <tr><td colspan="6" class="loading">Loading recommendations...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Main Books Section -->
        <h3 id="mainTableHeading" class="section-heading">All Books</h3>
        <table class="all-books-table">
            <thead>
                <tr id="mainTableHeaders">
                    <th>ID</th>
                    <th>Name</th>
                    <th>Author</th>
                    <th>Genre</th>
                    <th>Year</th>
                </tr>
            </thead>
            <tbody id="booksList">
                <tr><td colspan="5" class="loading">Loading books...</td></tr>
            </tbody>
        </table>

        <script>
            let allBooks = []; //storing all books globally to be able to use the search
            let currentRecommendationType = 'genre';
            let currentView = 'all'; // 'all' or 'my'

            function fetchBooks() {
                fetch("http://127.0.0.1:8000/books/")
                .then(response => response.json())
                .then(data => {
                    allBooks = data;
                    displayBooks(allBooks);
                    // Also load recommendations on initial page load
                    fetchRecommendations(currentRecommendationType);
                })
                .catch(error => {
                    console.error('Error fetching book list:', error);
                    document.getElementById("booksList").innerHTML = 
                        '<tr><td colspan="5">Error loading books. Please try again later.</td></tr>';
                });
            }

            function displayBooks(books){
                const books_list = document.getElementById("booksList");
                books_list.innerHTML = '';
                
                if (books.length === 0) {
                    books_list.innerHTML = '<tr><td colspan="5">No books found.</td></tr>';
                    return;
                }

                books.forEach(book => {
                    const row = `<tr>
                        <td>${book.book_id}</td>
                        <td>${book.book_name}</td>
                        <td>${book.author}</td>
                        <td>${book.genre}</td>
                        <td>${book.year}</td>
                        <td>
                            <button class="borrow-book" onclick="borrowBook(${book.book_id})">Borrow Book</button>
                        </td>
                    </tr>`;
                    books_list.innerHTML += row;
                });
            }

            function searchBooks() {
                if (currentView === 'my') return; // Don't search in my books view
                
                const query = document.getElementById('searchInput').value.toLowerCase();
                if (!allBooks.length) return;
                const filteredBooks = allBooks.filter(book =>
                    book.book_name.toLowerCase().includes(query) ||
                    book.author.toLowerCase().includes(query) ||
                    book.genre.toLowerCase().includes(query) ||
                    book.year.toString().includes(query)
                );
                displayBooks(filteredBooks);
            }

            function logOut() {
                sessionStorage.removeItem("username");
                sessionStorage.removeItem("user_id");
                window.location.href = 'index.html';
            }
            
            function viewAllBooks() {
                currentView = 'all';
                document.getElementById("mainTableHeading").textContent = "All Books";
                document.getElementById("mainTableHeaders").innerHTML = `
                    <th>ID</th>
                    <th>Name</th>
                    <th>Author</th>
                    <th>Genre</th>
                    <th>Year</th>
                `;
                displayBooks(allBooks);
                
                // Show recommendations section
                document.getElementById("recommendationsSection").style.display = "block";
                
                // Enable search
                document.querySelector(".search-container").style.display = "flex";
            }

            async function viewMyBooks() {
                currentView = 'my';
                document.getElementById("mainTableHeading").textContent = "My Borrowed Books";
                document.getElementById("mainTableHeaders").innerHTML = `
                    <th>Book Name</th>
                    <th>Borrow Date</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                `;
                
                // Hide recommendations when viewing My Books
                document.getElementById("recommendationsSection").style.display = "none";
                
                // Disable search for borrowed books
                document.querySelector(".search-container").style.display = "none";
                
                const user_id = sessionStorage.getItem("user_id");
                try {
                    const booksResponse = await fetch(`http://127.0.0.1:8000/mybooks/${user_id}`);
                    const borrowedBooks = await booksResponse.json();
                    displayBorrowedBooks(borrowedBooks);
                } catch (error) {
                    console.error("Error:", error);
                    // Display a message if there's an error or no books
                    const books_list = document.getElementById("booksList");
                    books_list.innerHTML = '<tr><td colspan="4">No books currently borrowed or error loading books.</td></tr>';
                }
            }

            function displayBorrowedBooks(books){
                const books_list = document.getElementById("booksList");
                books_list.innerHTML = '';
                
                if (books.length === 0) {
                    books_list.innerHTML = '<tr><td colspan="4">You have not borrowed any books yet.</td></tr>';
                    return;
                }

                books.forEach(book => {
                    const row = `<tr>
                        <td>${book.book_name}</td>
                        <td>${book.borrow_date}</td>
                        <td>${book.due_date}</td>
                        <td>
                            <button class="renew-book" onclick="renewBook(${book.book_id})">Renew Book</button>
                            <button class="return-book" onclick="returnBook(${book.book_id})">Return Book</button>
                        </td>
                    </tr>`;
                    books_list.innerHTML += row;
                });
            }
            
            function displayUsername() {
                const username = sessionStorage.getItem("username");
                if (username) {
                    document.getElementById("userGreeting").textContent = `Welcome, ${username}!`;
                }
            }

            function borrowBook(book_id){
                const user_id = sessionStorage.getItem("user_id");

                //check if book is available
                fetch(`http://127.0.0.1:8000/available/${book_id}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.available) {
                        //check if current user has already borrowed the book
                            fetch(`http://127.0.0.1:8000/mybooks/${user_id}`)
                            .then(response => response.json())
                            .then(borrowedBooks => {
                                const alreadyBorrowed = borrowedBooks.some(book => book.book_id === book_id);
                                if (alreadyBorrowed) {
                                    alert("You have already borrowed this book.");
                                } else {
                                    alert("Sorry, this book is currently unavailable.");
                                }
                            })
                    } else {
                        fetch(`http://127.0.0.1:8000/borrow/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                user_id: user_id,
                                book_id: book_id
                            })
                        })
                        .then(response => {
                            if (!response.ok) {
                                    throw new Error("Failed to borrow book");
                            }
                                return response.json();
                            })
                        .then(data => {
                                alert(data.message);
                                console.log(data);
                                // Refresh recommendations after borrowing
                                if (currentView === 'all') {
                                    fetchRecommendations(currentRecommendationType);
                                }
                        })
                        .catch(error => {
                            console.error("Failed to borrow book:", error);
                            alert("You have already borrowed this book.");
                        });
                    }
                })
            }

            function returnBook(book_id){
                const user_id = sessionStorage.getItem("user_id");

                fetch(`http://127.0.0.1:8000/return/`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            user_id: user_id,
                            book_id: book_id
                        })
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                        alert(data.message);
                        console.log(data);
                        // Refresh the borrowed books list
                        viewMyBooks();
                })
                .catch(error => {
                    console.error("Failed to return book:", error);
                    alert("No active loan found for this book.");
                });
            }

            function renewBook(book_id){
                const user_id = sessionStorage.getItem("user_id");

                fetch("http://127.0.0.1:8000/renew/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            user_id: user_id,
                            book_id: book_id
                        })
                })
                .then(response => {
                    return response.json();
                })
                .then(data => {
                        alert(data.message);
                        console.log(data);
                        // Refresh the borrowed books list
                        viewMyBooks();
                })
                .catch(error => {
                    console.error("Failed to renew book:", error);
                    alert("No active loan found for this book.");
                });
            }
            
            // Recommendations functions
            function showRecommendations(type) {
                currentRecommendationType = type;
                
                // Update active tab button
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.textContent.toLowerCase().includes(type)) {
                        button.classList.add('active');
                    }
                });
                
                // Show loading message while fetching
                document.getElementById("recommendationsList").innerHTML = 
                    '<tr><td colspan="6" class="loading">Loading recommendations...</td></tr>';
                
                fetchRecommendations(type);
            }
            
            async function fetchRecommendations(type) {
                const user_id = sessionStorage.getItem("user_id");
                if (!user_id) return;
                
                try {
                    let endpoint = `http://127.0.0.1:8000/recommendations/${user_id}`;
                    let params = new URLSearchParams();
                    
                    // Add appropriate parameters based on recommendation type
                    if (type === 'genre') {
                        // For genre-based recommendations, we can get user's preferred genres
                        // For now, let's use the default endpoint which already does this
                    } else if (type === 'author') {
                        // We'll add a 'by-author' parameter to signal our backend
                        params.append('by', 'author');
                    } else if (type === 'popular') {
                        // We'll set genres to blank to get popular books across all genres
                        params.append('popular', 'true');
                    }
                    
                    // Set limit
                    params.append('limit', '5');
                    
                    // Attach params to endpoint if we have any
                    if (params.toString()) {
                        endpoint += '?' + params.toString();
                    }
                    
                    const response = await fetch(endpoint);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    
                    const books = await response.json();
                    
                    // Add recommendation reasons based on the type
                    const booksWithReasons = books.map(book => ({
                        ...book,
                        reason: getRecommendationReason(book, type)
                    }));
                    
                    displayRecommendations(booksWithReasons);
                } catch (error) {
                    console.error("Error fetching recommendations:", error);
                    const recommendationsList = document.getElementById("recommendationsList");
                    recommendationsList.innerHTML = `<tr><td colspan="6">Error loading recommendations: ${error.message}</td></tr>`;
                }
            }
            
            // Helper function to generate recommendation reasons
            function getRecommendationReason(book, type) {
                if (type === 'genre') {
                    return `Based on your interest in ${book.genre} books`;
                } else if (type === 'author') {
                    return `More from author ${book.author} you might enjoy`;
                } else if (type === 'popular') {
                    return `Popular among library members`;
                }
                return 'Recommended for you';
            }
            
            function displayRecommendations(books) {
                const recommendationsList = document.getElementById("recommendationsList");
                recommendationsList.innerHTML = '';
                
                if (books.length === 0) {
                    recommendationsList.innerHTML = `<tr><td colspan="6">No recommendations available. Try borrowing more books!</td></tr>`;
                    return;
                }
                
                books.forEach(book => {
                    const row = `<tr>
                        <td>${book.book_id}</td>
                        <td>${book.book_name}</td>
                        <td>${book.author}</td>
                        <td>${book.genre}</td>
                        <td>${book.year}</td>
                        <td>${book.reason}</td>
                        <td>
                            <button class="borrow-book" onclick="borrowBook(${book.book_id})">Borrow Book</button>
                        </td>
                    </tr>`;
                    recommendationsList.innerHTML += row;
                });
            }

            window.onload = function(){
                fetchBooks();
                displayUsername();
            };
        </script>
    </body>
</html>
